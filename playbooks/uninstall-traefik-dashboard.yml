# playbooks/uninstall-traefik-dashboard.yml
# =========================================================
# üßπ Desinstalaci√≥n COMPLETA y segura de Traefik + recursos
# =========================================================
---
- name: üßπ Desinstalar Traefik y limpiar recursos relacionados
  hosts: localhost
  gather_facts: false

  vars_files:
    - ../vars/main.yml          # ‚Üê variables globales

  vars:
    kubeconfig_path: "/home/victory/.kube/config"
    helm_bin:       "/usr/local/bin/helm"
    kubectl_bin:    "/usr/local/bin/kubectl"
    work_dir:       "{{ playbook_dir }}/files"

  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
    PATH: "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

  tasks:
  # --------------------------------------------------------------------
  # 1. Limpieza local
  # --------------------------------------------------------------------
  - name: üóëÔ∏è  Borrar directorio temporal ¬´files/¬ª
    file:
      path: "{{ work_dir }}"
      state: absent

  # --------------------------------------------------------------------
  # 2. Helm release
  # --------------------------------------------------------------------
  - name: üîç ¬øExiste release Traefik?
    shell: "{{ helm_bin }} status {{ traefik_release_name }} -n {{ traefik_namespace }}"
    register: helm_status
    failed_when: false
    changed_when: false

  - name: ‚ùå Desinstalar release (si existe)
    shell: "{{ helm_bin }} uninstall {{ traefik_release_name }} -n {{ traefik_namespace }}"
    when: helm_status.rc == 0

  # --------------------------------------------------------------------
  # 3. Job que copi√≥ los certificados
  # --------------------------------------------------------------------
  - name: ‚ùå Eliminar Job ¬´copy-wildcard-cert¬ª
    shell: "{{ kubectl_bin }} delete job copy-wildcard-cert -n {{ traefik_namespace }} --ignore-not-found --wait=true --timeout=30s"

  # --------------------------------------------------------------------
  # 4. PVC  +  PV  (Longhorn)
  # --------------------------------------------------------------------
  - name: üîç Obtener JSON del PVC
    shell: "{{ kubectl_bin }} get pvc {{ traefik_pvc_name }} -n {{ traefik_namespace }} -o json"
    register: pvc_json
    failed_when: false
    changed_when: false

  - name: üß∞ Quitar finalizers si el PVC est√° bloqueado
    when:
      - pvc_json.rc == 0
      - '"finalizers"' in pvc_json.stdout
    shell: >
      {{ kubectl_bin }} patch pvc {{ traefik_pvc_name }}
      -n {{ traefik_namespace }}
      -p '{"metadata":{"finalizers":[]}}'
      --type=merge

  - name: ‚ùå Eliminar PVC
    shell: "{{ kubectl_bin }} delete pvc {{ traefik_pvc_name }} -n {{ traefik_namespace }} --ignore-not-found --wait=true --timeout=60s"

  - name: ‚ùå Eliminar PV hu√©rfano (si existe)
    shell: |
      PV=$({{ kubectl_bin }} get pv -o jsonpath='{range .items[*]}{.metadata.name}:{.spec.claimRef.name}{"\n"}{end}' \
           | awk -F: '$2 == "{{ traefik_pvc_name }}" {print $1}')
      if [ -n "$PV" ]; then
        {{ kubectl_bin }} delete pv "$PV" --wait=true --timeout=60s
      fi

  # --------------------------------------------------------------------
  # 5. Secretos (plano + SealedSecret)
  # --------------------------------------------------------------------
  - name: ‚ùå Eliminar secretos y SealedSecrets
    shell: |
      {{ kubectl_bin }} delete secret       {{ traefik_dashboard_secret_name }} -n {{ traefik_namespace }} --ignore-not-found
      {{ kubectl_bin }} delete sealedsecret {{ traefik_dashboard_secret_name }} -n {{ traefik_namespace }} --ignore-not-found
      {{ kubectl_bin }} delete secret       {{ internal_tls_secret_name }}    -n {{ traefik_namespace }} --ignore-not-found
      {{ kubectl_bin }} delete sealedsecret {{ internal_tls_secret_name }}    -n {{ traefik_namespace }} --ignore-not-found

  # --------------------------------------------------------------------
  # 6. CRDs de Traefik v3
  # --------------------------------------------------------------------
  - name: ‚ùå Eliminar CRDs Traefik v3
    shell: |
      for crd in ingressroutes ingressroutetcps ingressrouteudps \
                middlewares tlsoptions tlsstores \
                serverstransports serverstransporttcps traefikservices; do
        {{ kubectl_bin }} delete crd ${crd}.traefik.io --ignore-not-found
      done

  # --------------------------------------------------------------------
  # 7. Service / NodePort
  # --------------------------------------------------------------------
  - name: ‚ùå Eliminar Service traefik
    shell: "{{ kubectl_bin }} delete svc traefik -n {{ traefik_namespace }} --ignore-not-found"

  # --------------------------------------------------------------------
  # 8. Confirmaci√≥n final
  # --------------------------------------------------------------------
  - name: ‚úÖ Todo limpio
    debug:
      msg: "‚úÖ Traefik, Job, PVC(+PV), CRDs y secretos eliminados satisfactoriamente."