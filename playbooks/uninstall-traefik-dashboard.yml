# playbooks/uninstall-traefik-dashboard.yml
# =========================================================
# ğŸ§¹ DesinstalaciÃ³n robusta de Traefik + recursos
# - No falla si el clÃºster no responde
# =========================================================
---
- name: ğŸ§¹ Desinstalar Traefik y limpiar recursos relacionados
  hosts: localhost
  gather_facts: false

  vars_files:
    - ../vars/main.yml

  vars:
    kubeconfig_path: "/home/victory/.kube/config"
    helm_bin_path: "/usr/local/bin/helm"
    kubectl_bin_path: "/usr/local/bin/kubectl"
    files_dir: "{{ playbook_dir }}/files"

    #  ğŸ‘‰  Valores de Traefik (sobrescribibles desde vars/main.yml)
    traefik_namespace: "{{ traefik_namespace | default('kube-system') }}"
    traefik_release_name: "{{ traefik_release_name | default('traefik') }}"
    traefik_pvc_name: "{{ traefik_pvc_name | default('certificados-longhorn') }}"
    traefik_dashboard_secret_name: "{{ traefik_dashboard_secret_name | default('traefik-dashboard-secret') }}"
    internal_tls_secret_name: "{{ internal_tls_secret_name | default('wildcard-socialdevs-tls') }}"

  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
    PATH: "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

  tasks:
    # 0 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ” Comprobar conectividad al API-Server
      command: "{{ kubectl_bin_path }} version --short"
      register: api_check
      changed_when: false
      failed_when: false

    - name: ğŸ›ˆ Mostrar resultado conectividad
      debug:
        msg: >
          {{
            'âœ… API-Server accesible' if api_check.rc == 0
            else 'âš ï¸  API-Server NO accesible; se omitirÃ¡n tareas kubectl/helm'
          }}

    # 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ—‘ï¸ Borrar directorio temporal playbooks/files
      file:
        path: "{{ files_dir }}"
        state: absent
        force: true

    # 2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - block:
        - name: ğŸ” Â¿Existe release Traefik?
          shell: "{{ helm_bin_path }} status {{ traefik_release_name }} -n {{ traefik_namespace }} --quiet || true"
          register: helm_status
          changed_when: false

        - name: âŒ Desinstalar Helm release (si existe)
          when: helm_status.stdout != ""
          shell: "{{ helm_bin_path }} uninstall {{ traefik_release_name }} -n {{ traefik_namespace }} --wait --timeout 120s"

      when: api_check.rc == 0
      rescue:
        - debug:
            msg: "âš ï¸  No se pudo acceder a Helm/cluster; se continÃºa (modo tolerante)."

    # 3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: âŒ Eliminar Job copy-wildcard-cert (si existe)
      shell: "{{ kubectl_bin_path }} delete job copy-wildcard-cert -n {{ traefik_namespace }} --ignore-not-found --wait=false"
      when: api_check.rc == 0
      failed_when: false

    # 4 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - block:
        - name: ğŸ” Obtener JSON del PVC
          shell: "{{ kubectl_bin_path }} get pvc {{ traefik_pvc_name }} -n {{ traefik_namespace }} -o json || true"
          register: pvc_json
          changed_when: false

        - name: ğŸ§ª Tiene finalizer pvc-protection?
          set_fact:
            pvc_needs_patch: "{{ 'kubernetes.io/pvc-protection' in pvc_json.stdout }}"

        - name: ğŸ§° Quitar finalizers si el PVC estÃ¡ bloqueado
          when: pvc_needs_patch
          shell: |
            {{ kubectl_bin_path }} patch pvc {{ traefik_pvc_name }} \
              -n {{ traefik_namespace }} \
              --type merge \
              -p '{"metadata":{"finalizers":[]}}'

        - name: âŒ Eliminar PVC
          shell: "{{ kubectl_bin_path }} delete pvc {{ traefik_pvc_name }} -n {{ traefik_namespace }} --ignore-not-found --wait=false"

        - name: ğŸ” Buscar PV asociado al PVC
          shell: >
            {{ kubectl_bin_path }} get pv -o jsonpath='{.items[?(@.spec.claimRef.name=="{{ traefik_pvc_name }}")].metadata.name}'
          register: pv_name
          changed_when: false

        - name: âŒ Eliminar PV asociado
          when: pv_name.stdout != ""
          shell: "{{ kubectl_bin_path }} delete pv {{ pv_name.stdout }} --ignore-not-found --wait=false"

      when: api_check.rc == 0
      rescue:
        - debug:
            msg: "âš ï¸  No se pudo eliminar PVC/PV; cluster inaccesible. Continuamos."

    # 5 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: âŒ Eliminar Secret y SealedSecret (auth + TLS)
      shell: |
        {{ kubectl_bin_path }} delete secret {{ traefik_dashboard_secret_name }} -n {{ traefik_namespace }} --ignore-not-found
        {{ kubectl_bin_path }} delete sealedsecret {{ traefik_dashboard_secret_name }} -n {{ traefik_namespace }} --ignore-not-found
        {{ kubectl_bin_path }} delete secret {{ internal_tls_secret_name }} -n {{ traefik_namespace }} --ignore-not-found
        {{ kubectl_bin_path }} delete sealedsecret {{ internal_tls_secret_name }} -n {{ traefik_namespace }} --ignore-not-found
      when: api_check.rc == 0
      failed_when: false

    # 6 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: âŒ Eliminar CRDs Traefik v3
      loop:
        - ingressroutes
        - ingressroutetcps
        - ingressrouteudps
        - middlewares
        - tlsoptions
        - tlsstores
        - serverstransports
        - traefikservices
      loop_control:
        loop_var: crd
      shell: "{{ kubectl_bin_path }} delete crd {{ crd }}.traefik.io --ignore-not-found"
      when: api_check.rc == 0
      failed_when: false

    # 7 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: âŒ Eliminar Service traefik
      shell: "{{ kubectl_bin_path }} delete svc traefik -n {{ traefik_namespace }} --ignore-not-found --wait=false"
      when: api_check.rc == 0
      failed_when: false

    # 8 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: âœ… ConfirmaciÃ³n final
      debug:
        msg: "âœ… Proceso de limpieza completado. Recursos eliminados o cluster inaccesible pero sin errores fatales."