# ========================================================
# ğŸ§¹ FASE FINAL: DesinstalaciÃ³n segura de Traefik
# Elimina Helm release, secretos, CRDs, servicios y limpia puertos ocupados
# ========================================================

- name: ğŸ§¹ Desinstalar Traefik y limpiar recursos relacionados
  hosts: localhost
  gather_facts: false
  become: true

  vars_files:
    - ../vars/main.yml

  vars:
    kubeconfig_path: "/home/victory/.kube/config"
    helm_bin_path: "/usr/local/bin/helm"
    kubectl_bin_path: "/usr/local/bin/kubectl"
    env_path: "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
    traefik_namespace: "kube-system"
    traefik_release_name: "traefik"
    internal_tls_secret_name: "internal-tls-secret"
    traefik_dashboard_secret_name: "traefik-dashboard-secret"
    playbooks_files_path: "playbooks/files/"
    ports_to_release: [32591, 31541, 31900, 32124, 31050]  # Fijos + los dinÃ¡micos recientes

  tasks:

    - name: ğŸ—‘ï¸ Eliminar archivos generados
      file:
        path: "{{ playbooks_files_path }}"
        state: absent

    - name: ğŸ” Verificar si Helm release existe
      shell: "{{ helm_bin_path }} status {{ traefik_release_name }} -n {{ traefik_namespace }}"
      environment: { PATH: "{{ env_path }}" }
      register: helm_status
      failed_when: false
      changed_when: false

    - name: âŒ Desinstalar Helm release Traefik
      shell: "{{ helm_bin_path }} uninstall {{ traefik_release_name }} -n {{ traefik_namespace }}"
      environment: { PATH: "{{ env_path }}" }
      when: helm_status.rc == 0

    - name: âŒ Eliminar secretos relacionados
      shell: >
        {{ kubectl_bin_path }} delete secret {{ traefik_dashboard_secret_name }} -n {{ traefik_namespace }} --ignore-not-found &&
        {{ kubectl_bin_path }} delete sealedsecret {{ traefik_dashboard_secret_name }} -n {{ traefik_namespace }} --ignore-not-found &&
        {{ kubectl_bin_path }} delete secret {{ internal_tls_secret_name }} -n {{ traefik_namespace }} --ignore-not-found
      environment: { KUBECONFIG: "{{ kubeconfig_path }}" }

    - name: âŒ Eliminar CRDs de Traefik si existen
      shell: |
        set -e
        {{ kubectl_bin_path }} delete crd ingressroutes.traefik.io --ignore-not-found
        {{ kubectl_bin_path }} delete crd ingressroutetcps.traefik.io --ignore-not-found
        {{ kubectl_bin_path }} delete crd ingressrouteudps.traefik.io --ignore-not-found
        {{ kubectl_bin_path }} delete crd middlewares.traefik.io --ignore-not-found
        {{ kubectl_bin_path }} delete crd tlsoptions.traefik.io --ignore-not-found
        {{ kubectl_bin_path }} delete crd tlsstores.traefik.io --ignore-not-found
        {{ kubectl_bin_path }} delete crd serverstransports.traefik.io --ignore-not-found
        {{ kubectl_bin_path }} delete crd serverstransporttcps.traefik.io --ignore-not-found
        {{ kubectl_bin_path }} delete crd traefikservices.traefik.io --ignore-not-found
      environment: { KUBECONFIG: "{{ kubeconfig_path }}" }

    - name: âŒ Eliminar el Service traefik si existe
      shell: "{{ kubectl_bin_path }} delete svc traefik -n {{ traefik_namespace }} --ignore-not-found"
      environment: { KUBECONFIG: "{{ kubeconfig_path }}" }

    - name: ğŸ” Verificar servicios que usan los puertos
      shell: "ss -tulnp | grep -E '{{ ports_to_release | join(\"|\") }}' || true"
      register: used_ports_output
      changed_when: false

    - name: ğŸ”’ Eliminar reglas nftables que aceptan esos puertos
      shell: |
        for port in {{ ports_to_release | join(" ") }}; do
          if ss -tuln | grep ":$port"; then
            echo "ğŸ›‘ Cerrando puerto $port"
            nft delete rule inet filter input tcp dport $port accept || true
          fi
        done
      when: used_ports_output.stdout != ""
      register: firewall_cleanup
      failed_when: false

    - name: âœ… ConfirmaciÃ³n final
      debug:
        msg: "âœ… Traefik desinstalado y puertos liberados con Ã©xito."