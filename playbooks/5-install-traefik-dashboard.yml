# playbooks/5-install-traefik-dashboard.yml
# ========================================================
# ğŸš€ Instalar Traefik con Dashboard interno protegido
# ========================================================

- name: ğŸš€ Instalar Traefik con Dashboard interno protegido
  hosts: localhost
  gather_facts: false
  become: false

  vars_files:
    - ../vars/main.yml

  vars:
    kubeconfig_path: "/home/victory/.kube/config"
    helm_bin_path: "/usr/local/bin/helm"
    kubectl_bin_path: "/usr/local/bin/kubectl"
    env_path: "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
    files_dir: "{{ playbook_dir }}/files"
    traefik_values_file: "{{ files_dir }}/traefik-values.yaml"
    sealed_secret_path: "{{ files_dir }}/traefik-dashboard-sealed.yaml"
    traefik_values_template: "../templates/traefik/values_pvc.yaml.j2"
    ingressroute_template: "../templates/traefik/traefik-dashboard-ingressroute.yaml.j2"
    rendered_ingressroute: "{{ files_dir }}/traefik-dashboard-ingressroute.yaml"
    middleware_template: "../templates/traefik/traefik-dashboard-middleware.yaml.j2"
    rendered_middleware: "{{ files_dir }}/traefik-dashboard-middleware.yaml"
    strip_middleware_template: "../templates/traefik/strip-prefix-middleware.yaml.j2"
    rendered_strip_middleware: "{{ files_dir }}/strip-prefix-middleware.yaml"
    tlsstore_template: "../templates/traefik/tlsstore-default.yaml.j2"
    rendered_tlsstore_file: "{{ files_dir }}/tlsstore-default.yaml"

  tasks:
    # âœ… Validar herramientas necesarias
    - name: ğŸ“‹ Verificar si kubectl estÃ¡ instalado
      stat:
        path: "{{ kubectl_bin_path }}"
      register: kubectl_check

    - name: âŒ Abortamos si kubectl no estÃ¡ instalado
      fail:
        msg: "âŒ kubectl no estÃ¡ instalado en {{ kubectl_bin_path }}."
      when: not kubectl_check.stat.exists

    - name: ğŸ“‹ Verificar si helm estÃ¡ instalado
      stat:
        path: "{{ helm_bin_path }}"
      register: helm_check

    - name: âŒ Abortamos si helm no estÃ¡ instalado
      fail:
        msg: "âŒ helm no estÃ¡ instalado en {{ helm_bin_path }}."
      when: not helm_check.stat.exists

    # ğŸ“ Crear carpeta files si no existe
    - name: ğŸ“ Asegurar directorio {{ files_dir }}
      file:
        path: "{{ files_dir }}"
        state: directory
        mode: "0755"

    # ğŸ“„ Renderizar valores Helm desde plantilla
    - name: ğŸ“„ Renderizar traefik-values.yaml
      template:
        src: "{{ traefik_values_template }}"
        dest: "{{ traefik_values_file }}"

    # ğŸ§¹ Limpieza previa (Traefik default)
    - name: ğŸ§¼ Verificar y eliminar Traefik preinstalado por K3s
      block:
        - name: ğŸ” Verificar Deployment traefik
          shell: >
            {{ kubectl_bin_path }} get deployment {{ traefik_release_name }} -n {{ traefik_namespace }}
          environment:
            KUBECONFIG: "{{ kubeconfig_path }}"
          register: traefik_deploy_check
          failed_when: false
          changed_when: false

        - name: âŒ Eliminar Deployment traefik
          shell: >
            {{ kubectl_bin_path }} delete deployment {{ traefik_release_name }} -n {{ traefik_namespace }} --wait=true --timeout=60s
          environment:
            KUBECONFIG: "{{ kubeconfig_path }}"
          when: traefik_deploy_check.rc == 0

        - name: ğŸ” Verificar HelmChart traefik de K3s
          shell: >
            {{ kubectl_bin_path }} get helmchart traefik -n {{ traefik_namespace }}
          environment:
            KUBECONFIG: "{{ kubeconfig_path }}"
          register: k3s_helmchart_check
          failed_when: false
          changed_when: false

        - name: âŒ Eliminar HelmChart traefik de K3s
          shell: >
            {{ kubectl_bin_path }} delete helmchart traefik -n {{ traefik_namespace }} --wait=true --timeout=60s
          environment:
            KUBECONFIG: "{{ kubeconfig_path }}"
          when: k3s_helmchart_check.rc == 0

    # â• AÃ±adir repositorio Traefik Helm Chart
    - name: â• AÃ±adir repositorio Helm de Traefik
      shell: >
        {{ helm_bin_path }} repo add traefik https://traefik.github.io/charts &&
        {{ helm_bin_path }} repo update
      environment:
        PATH: "{{ env_path }}"

    # ğŸ” Aplicar Secret sellado
    - name: ğŸ” Aplicar Secret sellado (auth)
      kubernetes.core.k8s:
        state: present
        src: "{{ sealed_secret_path }}"
        namespace: "{{ traefik_namespace }}"
        kubeconfig: "{{ kubeconfig_path }}"
      when: sealed_secret_path is defined and lookup('file', sealed_secret_path, errors='ignore') is not none

    - name: â³ Esperar a que el Secret se desencripte
      shell: >
        {{ kubectl_bin_path }} -n {{ traefik_namespace }} get secret {{ traefik_dashboard_secret_name }}
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      register: wait_for_secret
      retries: 6
      delay: 5
      until: wait_for_secret.rc == 0
      failed_when: wait_for_secret.rc != 0

    # ğŸ“¥ Instalar CRDs de Traefik v3.0
    - name: ğŸ“¥ Instalar CRDs oficiales Traefik v3.0
      shell: |
        curl -sSfL https://raw.githubusercontent.com/traefik/traefik/v3.0/docs/content/reference/dynamic-configuration/kubernetes-crd-definition-v1.yml | {{ kubectl_bin_path }} apply -f -
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      changed_when: true

    # ğŸ“¦ Instalar Traefik vÃ­a Helm
    - name: ğŸ“¦ Instalar Traefik desde Helm
      shell: >
        {{ helm_bin_path }} upgrade --install {{ traefik_release_name }} traefik/traefik
        --namespace {{ traefik_namespace }}
        --create-namespace
        --version {{ traefik_chart_version }}
        --values {{ traefik_values_file }}
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
        PATH: "{{ env_path }}"

    - name: â³ Esperar despliegue Traefik
      shell: >
        {{ kubectl_bin_path }} rollout status deployment/{{ traefik_release_name }} -n {{ traefik_namespace }}
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    # ğŸŒ IngressRoute del Dashboard
    - name: ğŸŒ Renderizar IngressRoute del Dashboard
      template:
        src: "{{ ingressroute_template }}"
        dest: "{{ rendered_ingressroute }}"

    - name: ğŸš€ Aplicar IngressRoute del Dashboard
      kubernetes.core.k8s:
        state: present
        namespace: "{{ traefik_namespace }}"
        src: "{{ rendered_ingressroute }}"
        kubeconfig: "{{ kubeconfig_path }}"

    # ğŸ” Middleware de AutenticaciÃ³n
    - name: ğŸ” Renderizar Middleware de AutenticaciÃ³n
      template:
        src: "{{ middleware_template }}"
        dest: "{{ rendered_middleware }}"

    - name: ğŸš€ Aplicar Middleware de AutenticaciÃ³n
      kubernetes.core.k8s:
        state: present
        namespace: "{{ traefik_namespace }}"
        src: "{{ rendered_middleware }}"
        kubeconfig: "{{ kubeconfig_path }}"

    # ğŸ§© Middleware strip-prefix (/dashboard, /api)
    - name: ğŸ§© Renderizar Middleware strip-prefix
      template:
        src: "{{ strip_middleware_template }}"
        dest: "{{ rendered_strip_middleware }}"

    - name: ğŸš€ Aplicar Middleware strip-prefix
      kubernetes.core.k8s:
        state: present
        namespace: "{{ traefik_namespace }}"
        src: "{{ rendered_strip_middleware }}"
        kubeconfig: "{{ kubeconfig_path }}"

    # ğŸ“„ TLSStore global
    - name: ğŸ“„ Renderizar TLSStore global
      template:
        src: "{{ tlsstore_template }}"
        dest: "{{ rendered_tlsstore_file }}"

    - name: ğŸš€ Aplicar TLSStore global
      kubernetes.core.k8s:
        state: present
        kubeconfig: "{{ kubeconfig_path }}"
        src: "{{ rendered_tlsstore_file }}"