# playbooks/1-generate-selfsigned-certs.yml
# ============================================================
# üõ°Ô∏è FASE 1A: Generar certificados wildcard autofirmados
# - Se crean en ./files/certs/
# - Se copian autom√°ticamente a /etc/traefik/certs en master1
# ============================================================

- name: üõ°Ô∏è Generar certificados wildcard autofirmados para Traefik
  hosts: localhost
  become: true

  vars_files:
    - ../vars/main.yml

  vars:
    certs_dir: "./files/certs"
    cert_name: "traefik"
    country: "ES"
    state: "Madrid"
    locality: "Madrid"
    organization: "FlatcarMicroCloud"
    common_name: "*.socialdevs.site"
    san_file: "/tmp/san.cnf"
    force_recreate: false
    ssh_key_path: "/root/.ssh/cluster_k3s/shared/id_rsa_shared_cluster"

  tasks:
    - name: üìÅ Crear directorio de certificados local
      ansible.builtin.raw:
        cmd: mkdir -p {{ certs_dir }} && chmod 755 {{ certs_dir }}

    - name: üìã Verificar existencia de certificado
      ansible.builtin.raw:
        cmd: stat {{ certs_dir }}/{{ cert_name }}.crt
      register: cert_stat
      changed_when: false

    - name: üìã Verificar existencia de clave privada
      ansible.builtin.raw:
        cmd: stat {{ certs_dir }}/{{ cert_name }}.key
      register: key_stat
      changed_when: false

    - name: üìù Crear archivo SAN temporal
      ansible.builtin.copy:
        dest: "{{ san_file }}"
        content: |
          [req]
          default_bits       = 4096
          prompt             = no
          default_md         = sha256
          req_extensions     = req_ext
          distinguished_name = dn

          [dn]
          C={{ country }}
          ST={{ state }}
          L={{ locality }}
          O={{ organization }}
          CN={{ common_name }}

          [req_ext]
          subjectAltName = @alt_names

          [alt_names]
          DNS.1 = *.socialdevs.site
          DNS.2 = socialdevs.site
          DNS.3 = jenkins.socialdevs.site
          DNS.4 = grafana.socialdevs.site
          DNS.5 = argocd.socialdevs.site
          DNS.6 = prometheus.socialdevs.site

    - name: üîê Generar clave privada
      ansible.builtin.command:
        cmd: openssl genrsa -out {{ certs_dir }}/{{ cert_name }}.key 4096
      when: force_recreate or not key_stat.stat.exists

    - name: üìú Generar certificado wildcard autofirmado
      ansible.builtin.command:
        cmd: >
          openssl req -x509 -nodes -days 3650
          -key {{ certs_dir }}/{{ cert_name }}.key
          -out {{ certs_dir }}/{{ cert_name }}.crt
          -config {{ san_file }}
          -extensions req_ext
      when: force_recreate or not cert_stat.stat.exists

    - name: üîê Establecer permisos locales
      ansible.builtin.raw:
        cmd: chmod 0644 {{ certs_dir }}/{{ cert_name }}.crt
      changed_when: false

    - name: üîê Establecer permisos locales para la clave
      ansible.builtin.raw:
        cmd: chmod 0600 {{ certs_dir }}/{{ cert_name }}.key
      changed_when: false

    - name: üßπ Eliminar archivo temporal SAN
      ansible.builtin.file:
        path: "{{ san_file }}"
        state: absent

    - name: üìÅ Crear directorio remoto /etc/traefik/certs en master1
      ansible.builtin.raw:
        cmd: mkdir -p /etc/traefik/certs && chmod 755 /etc/traefik/certs
      delegate_to: "{{ master1_ip }}"

    - name: üì§ Copiar traefik.crt a master1
      ansible.builtin.shell:
        cmd: >
          scp -i {{ ssh_key_path }} -o StrictHostKeyChecking=no
          {{ certs_dir }}/{{ cert_name }}.crt
          root@{{ master1_ip }}:/etc/traefik/certs/{{ cert_name }}.crt
      delegate_to: localhost

    - name: üì§ Copiar traefik.key a master1
      ansible.builtin.shell:
        cmd: >
          scp -i {{ ssh_key_path }} -o StrictHostKeyChecking=no
          {{ certs_dir }}/{{ cert_name }}.key
          root@{{ master1_ip }}:/etc/traefik/certs/{{ cert_name }}.key
      delegate_to: localhost

    - name: üîê Establecer permisos remotos en master1
      ansible.builtin.raw:
        cmd: |
          chmod 0644 /etc/traefik/certs/{{ cert_name }}.crt
          chmod 0600 /etc/traefik/certs/{{ cert_name }}.key
      delegate_to: "{{ master1_ip }}"

    - name: Verificar los archivos de certificados en master1
      ansible.builtin.stat:
        path: "/etc/traefik/certs/{{ cert_name }}.crt"
      delegate_to: "{{ master1_ip }}"
      register: cert_check

    - name: Verificar los permisos de los archivos en master1
      ansible.builtin.debug:
        msg: "Certificado y clave copiados correctamente a /etc/traefik/certs/"
      when: cert_check.stat.exists
