- name: ğŸ›¡ï¸ Generar CA raÃ­z y certificado wildcard firmado
  hosts: localhost
  gather_facts: false

  vars:
    certs_dir: "{{ playbook_dir }}/files/certs"
    ca_key: ca-root.key
    ca_csr: ca-root.csr
    ca_crt: ca-root.crt
    server_key: wildcard-socialdevs-tls.key
    server_csr: wildcard-socialdevs-tls.csr
    server_crt: wildcard-socialdevs-tls.crt

    country: ES
    state: Madrid
    locality: Madrid
    organization: FlatcarMicroCloud
    common_name: "*.socialdevs.site"

    extra_sans:
      - socialdevs.site
      - grafana.socialdevs.site
      - jenkins.socialdevs.site
      - argocd.socialdevs.site
      - prometheus.socialdevs.site
      - longhorn.socialdevs.site
      - traefik.socialdevs.site

    force_recreate: false

  tasks:
    - name: ğŸ“ Crear directorio de certificados
      file:
        path: "{{ certs_dir }}"
        state: directory
        mode: "0755"

    - name: ğŸ” Crear clave privada de la CA
      community.crypto.openssl_privatekey:
        path: "{{ certs_dir }}/{{ ca_key }}"
        size: 4096
        type: RSA
        force: "{{ force_recreate | bool }}"

    - name: ğŸ“ Crear CSR de la CA
      community.crypto.openssl_csr:
        path: "{{ certs_dir }}/{{ ca_csr }}"
        privatekey_path: "{{ certs_dir }}/{{ ca_key }}"
        common_name: "RootCA"
        country_name: "{{ country }}"
        state_or_province_name: "{{ state }}"
        locality_name: "{{ locality }}"
        organization_name: "{{ organization }}"
        force: "{{ force_recreate | bool }}"

    - name: ğŸ“œ Crear certificado autofirmado de la CA desde CSR
      community.crypto.x509_certificate:
        path: "{{ certs_dir }}/{{ ca_crt }}"
        csr_path: "{{ certs_dir }}/{{ ca_csr }}"
        privatekey_path: "{{ certs_dir }}/{{ ca_key }}"
        provider: selfsigned
        selfsigned_not_after: "+3650d"
        selfsigned_version: 3
        selfsigned_create_subject_key_identifier: create_if_not_provided
        force: "{{ force_recreate | bool }}"

    - name: ğŸ”‘ Crear clave privada para el certificado wildcard
      community.crypto.openssl_privatekey:
        path: "{{ certs_dir }}/{{ server_key }}"
        size: 2048
        type: RSA
        force: "{{ force_recreate | bool }}"

    - name: ğŸ“ Crear CSR para el wildcard (*.socialdevs.site)
      community.crypto.openssl_csr:
        path: "{{ certs_dir }}/{{ server_csr }}"
        privatekey_path: "{{ certs_dir }}/{{ server_key }}"
        common_name: "{{ common_name }}"
        subject_alt_name: >-
          DNS:{{ common_name }},{{ extra_sans | map('regex_replace', '^(.*)$', 'DNS:\\1') | join(',') }}
        force: "{{ force_recreate | bool }}"

    - name: âœ… Firmar el CSR con la CA raÃ­z
      community.crypto.x509_certificate:
        path: "{{ certs_dir }}/{{ server_crt }}"
        csr_path: "{{ certs_dir }}/{{ server_csr }}"
        provider: ownca
        ownca_path: "{{ certs_dir }}/{{ ca_crt }}"
        ownca_privatekey_path: "{{ certs_dir }}/{{ ca_key }}"
        ownca_not_after: "+3650d"
        attributes:
          - name: basicConstraints
            value: "CA:FALSE"
          - name: keyUsage
            value: "digitalSignature,keyEncipherment"
          - name: extendedKeyUsage
            value: "serverAuth"
          - name: subjectAltName
            value: >-
              DNS:{{ common_name }},{{ extra_sans | map('regex_replace', '^(.*)$', 'DNS:\\1') | join(',') }}
        force: "{{ force_recreate | bool }}"

    # âœ… CorrecciÃ³n de permisos despuÃ©s de generar los certificados
    - name: âš™ï¸ Ajustar permisos para la clave privada de la CA
      file:
        path: "{{ certs_dir }}/{{ ca_key }}"
        mode: "0600"

    - name: âš™ï¸ Ajustar permisos para el certificado de la CA
      file:
        path: "{{ certs_dir }}/{{ ca_crt }}"
        mode: "0644"

    - name: âš™ï¸ Ajustar permisos para la clave privada del wildcard
      file:
        path: "{{ certs_dir }}/{{ server_key }}"
        mode: "0600"

    - name: âš™ï¸ Ajustar permisos para el certificado wildcard
      file:
        path: "{{ certs_dir }}/{{ server_crt }}"
        mode: "0644"

    - name: ğŸ§¹ Borrar CSRs temporales (opcional)
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ certs_dir }}/{{ ca_csr }}"
        - "{{ certs_dir }}/{{ server_csr }}"
      when: not force_recreate | bool

    - name: ğŸ“„ Mostrar resumen de archivos generados
      shell: ls -l "{{ certs_dir }}"
      register: certs_output

    - name: ğŸ“¤ Mostrar salida de archivos
      debug:
        msg: "{{ certs_output.stdout_lines }}"