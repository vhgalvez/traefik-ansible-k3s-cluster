# playbooks/01_generate-ca-and-wildcard.yml
# =========================================
#  Genera una autoridad certificadora (CA)
#  raÃ­z autofirmada (RootCA) si no existe,
#  y un certificado wildcard firmado para
#  *.socialdevs.site con su clave privada.
#
#  âœ” CA: ca-root.crt y ca-root.key
#  âœ” Wildcard: wildcard-socialdevs-tls.crt y .key
#  âœ” SANs incluidos (*.socialdevs.site, grafana, jenkins, etc.)
#  âœ” Compatible para importar la CA en Firefox/Chrome
#
#  âžœ Salida en: files/certs/
#  âžœ Ãštil para desarrollo, clusters internos o laboratorios
# =========================================

- name: ðŸ›¡ï¸ Generar CA raÃ­z y certificado wildcard firmado
  hosts: localhost
  gather_facts: false

  vars:
    certs_dir: "{{ playbook_dir }}/files/certs"
    ca_key:   ca-root.key
    ca_crt:   ca-root.crt
    server_key: wildcard-socialdevs-tls.key
    server_csr: wildcard-socialdevs-tls.csr
    server_crt: wildcard-socialdevs-tls.crt

    # Distinguish names:
    country:      ES
    state:        Madrid
    locality:     Madrid
    organization: FlatcarMicroCloud
    common_name:  "*.socialdevs.site"

    extra_sans:
      - socialdevs.site
      - jenkins.socialdevs.site
      - grafana.socialdevs.site
      - argocd.socialdevs.site
      - prometheus.socialdevs.site

    force_recreate: false

  tasks:
    - name: ðŸ“ Crear directorio para certificados
      file:
        path: "{{ certs_dir }}"
        state: directory
        mode: "0755"

    - name: ðŸ” Crear clave privada de CA raÃ­z
      community.crypto.openssl_privatekey:
        path: "{{ certs_dir }}/{{ ca_key }}"
        size: 4096
        type: RSA
        mode: "0600"
        force: "{{ force_recreate | bool }}"

    - name: ðŸ“œ Generar certificado de CA raÃ­z (autofirmado)
      community.crypto.openssl_certificate:
        path: "{{ certs_dir }}/{{ ca_crt }}"
        privatekey_path: "{{ certs_dir }}/{{ ca_key }}"
        provider: selfsigned
        selfsigned_subject: "/C={{ country }}/ST={{ state }}/L={{ locality }}/O={{ organization }}/CN=RootCA"
        selfsigned_not_after: "+3650d"
        basic_constraints:
          ca: true
          pathlen: 0
        key_usage:
          - keyCertSign
          - cRLSign
        mode: "0644"
        force: "{{ force_recreate | bool }}"

    - name: ðŸ”‘ Generar clave privada para el servidor
      community.crypto.openssl_privatekey:
        path: "{{ certs_dir }}/{{ server_key }}"
        size: 2048
        type: RSA
        mode: "0600"
        force: "{{ force_recreate | bool }}"

    - name: ðŸ“„ Crear CSR para el wildcard
      community.crypto.openssl_csr:
        path: "{{ certs_dir }}/{{ server_csr }}"
        privatekey_path: "{{ certs_dir }}/{{ server_key }}"
        common_name: "{{ common_name }}"
        subject_alt_name: >-
          DNS:{{ common_name }},
          {% for san in extra_sans %}
          DNS:{{ san }}{% if not loop.last %},{% endif %}
          {% endfor %}
        mode: "0644"
        force: "{{ force_recreate | bool }}"

    - name: âœï¸ Firmar CSR con CA raÃ­z
      community.crypto.openssl_certificate:
        path: "{{ certs_dir }}/{{ server_crt }}"
        csr_path: "{{ certs_dir }}/{{ server_csr }}"
        privatekey_path: "{{ certs_dir }}/{{ ca_key }}"
        certificate: "{{ certs_dir }}/{{ ca_crt }}"
        provider: ownca
        ownca_not_after: "+3650d"
        ownca_extensions:
          basicConstraints: "CA:FALSE"
          keyUsage: "digitalSignature,keyEncipherment"
          extendedKeyUsage: "serverAuth"
          subjectAltName: >-
            DNS:{{ common_name }},
            {% for san in extra_sans %}
            DNS:{{ san }}{% if not loop.last %},{% endif %}
            {% endfor %}
        mode: "0644"
        force: "{{ force_recreate | bool }}"

    - name: ðŸ§¹ Eliminar CSR temporal (opcional)
      file:
        path: "{{ certs_dir }}/{{ server_csr }}"
        state: absent
      when: not force_recreate | bool
