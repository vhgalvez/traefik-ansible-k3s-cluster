# playbooks\generate_traefik_secrets.yml
- name: 🔐 Generar y cifrar Secret para Traefik Dashboard
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../vars/main.yml

  tasks:

    - name: 🔐 Generar hash htpasswd para Traefik
      command: >
        python3 -c "import crypt; print('{{ traefik_auth_user }}:' + crypt.crypt('{{ traefik_auth_pass }}', crypt.mksalt(crypt.METHOD_MD5)))"
      register: traefik_htpasswd_output
      changed_when: false

    - name: 📄 Renderizar plantilla de Secret base
      template:
        src: ../templates/secrets/traefik-dashboard-secret.yaml.j2
        dest: ../rendered-secrets/traefik-dashboard-secret.yaml
      vars:
        traefik_basic_auth: "{{ traefik_htpasswd_output.stdout }}"

    - name: 🔐 Cifrar con kubeseal
      command: >
        kubeseal
          --controller-name sealed-secrets-controller
          --controller-namespace kube-system
          --format yaml
          < ../rendered-secrets/traefik-dashboard-secret.yaml
          > ../sealed-secrets/traefik-dashboard-sealed.yaml
      changed_when: false
