# playbooks/deploy_traefik.yml
---
- name: ğŸ” Generar Secret sellado para Traefik Dashboard
  import_playbook: generate_traefik_secrets.yml

- name: ğŸš€ Instalar Traefik con Helm
  import_playbook: install_traefik.yml

- name: âœ… Verificar despliegue de Traefik
  hosts: localhost
  gather_facts: false
  vars:
    kubeconfig_path: "/home/victory/.kube/config"
    kubectl_bin_path: "/usr/local/bin/kubectl"
  tasks:
    - name: â³ Esperar pods de Traefik
      shell: >
        {{ kubectl_bin_path }} -n kube-system wait --for=condition=Ready pod
        -l app.kubernetes.io/name=traefik --timeout=60s
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      register: wait_output
      changed_when: false

    - name: ğŸ” Verificar estado de pods de Traefik
      shell: >
        {{ kubectl_bin_path }} get pods -n kube-system -l app.kubernetes.io/name=traefik
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      register: traefik_status

    - name: ğŸ§¾ Mostrar estado de Traefik
      debug:
        var: traefik_status.stdout_lines
    
    - name: ğŸšª Desplegar IngressRoute para Dashboard
      kubernetes.core.k8s:
        state: present
        namespace: kube-system
        src: playbooks/files/traefik-dashboard-ingressroute.yaml