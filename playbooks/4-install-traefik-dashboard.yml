# playbooks/4-install-traefik-dashboard.yml
# ========================================================
# ğŸš€ FASE 2: Instalar Traefik con dashboard interno protegido
# Usa certificados y secretos generados en la fase 1.
# Despliega Traefik con autenticaciÃ³n y dashboard local.
# ========================================================

- name: ğŸš€ Instalar Traefik con Dashboard interno protegido
  hosts: localhost
  gather_facts: false
  become: false

  vars_files:
    - ../vars/main.yml

  vars:
    kubeconfig_path: "/home/victory/.kube/config"
    helm_bin_path: "/usr/local/bin/helm"
    kubectl_bin_path: "/usr/local/bin/kubectl"
    env_path: "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
    files_dir: "{{ playbook_dir }}/files"
    traefik_values_file: "{{ files_dir }}/traefik-values.yaml"
    sealed_secret_path: "{{ files_dir }}/traefik-dashboard-sealed.yaml"
    traefik_values_template: "../templates/traefik/values_nopvc.yaml.j2"
    ingressroute_template: "../templates/traefik/traefik-dashboard-ingressroute-internal.yaml.j2"
    rendered_ingressroute: "{{ files_dir }}/traefik-dashboard-ingressroute.yaml"
    middleware_template: "../templates/traefik/traefik-dashboard-middleware.yaml.j2"
    rendered_middleware: "{{ files_dir }}/traefik-dashboard-middleware.yaml"

  tasks:
    # Asegurar que el directorio de archivos estÃ© presente
    - name: ğŸ“ Asegurar directorio local files/
      ansible.builtin.file:
        path: "{{ files_dir }}"
        state: directory
        mode: "0755"

    # Renderizar el archivo `values.yaml` desde la plantilla
    - name: ğŸ“„ Renderizar values.yaml desde plantilla
      ansible.builtin.template:
        src: "{{ traefik_values_template }}"
        dest: "{{ traefik_values_file }}"

    # SecciÃ³n de limpieza: Asegura que no haya instalaciones previas de Traefik
    - name: ğŸ§¹ Limpiar instalaciones previas de Traefik (si existen)
      block:
        - name: ğŸ” Comprobar si el release de Helm 'traefik' existe
          ansible.builtin.shell: "{{ helm_bin_path }} status {{ traefik_release_name }} -n {{ traefik_namespace }}"
          environment:
            PATH: "{{ env_path }}"
          register: helm_release_status
          changed_when: false
          failed_when: false  # Ignorar error si el release no se encuentra

        - name: âŒ Desinstalar release de Helm 'traefik'
          ansible.builtin.shell: "{{ helm_bin_path }} uninstall {{ traefik_release_name }} -n {{ traefik_namespace }}"
          environment:
            PATH: "{{ env_path }}"
          when: helm_release_status.rc == 0  # Solo desinstalar si el release existe
          changed_when: true  # Marcar como cambiado si el comando de desinstalaciÃ³n se ejecuta

        - name: ğŸ” Comprobar si Traefik por defecto de K3s (helmcharts) existe
          ansible.builtin.shell: "{{ kubectl_bin_path }} get helmcharts {{ traefik_release_name }} -n kube-system"
          environment:
            KUBECONFIG: "{{ kubeconfig_path }}"
            PATH: "{{ env_path }}"
          register: k3s_helmchart_status
          changed_when: false
          failed_when: false  # Ignorar error si el helmchart no se encuentra

        - name: âŒ Eliminar Traefik por defecto de K3s (helmcharts)
          ansible.builtin.shell: "{{ kubectl_bin_path }} delete helmcharts {{ traefik_release_name }} -n kube-system"
          environment:
            KUBECONFIG: "{{ kubeconfig_path }}"
            PATH: "{{ env_path }}"
          when: k3s_helmchart_status.rc == 0  # Solo eliminar si el helmchart existe
          changed_when: true  # Marcar como cambiado si el comando de eliminaciÃ³n se ejecuta
      rescue:
        - name: âš ï¸ Advertencia durante la limpieza
          ansible.builtin.debug:
            msg: "Se produjo un error inesperado durante la limpieza de Traefik, pero el playbook continÃºa."
          when: ansible_failed_result is defined and ansible_failed_result.rc != 1

    # AÃ±adir repositorio de Helm de Traefik
    - name: â• AÃ±adir repositorio Helm de Traefik
      ansible.builtin.shell: >
        {{ helm_bin_path }} repo add traefik https://traefik.github.io/charts &&
        {{ helm_bin_path }} repo update
      environment:
        PATH: "{{ env_path }}"

    # Aplicar el Secret sellado (autenticaciÃ³n) para el dashboard
    - name: ğŸ“¥ Aplicar Secret sellado (auth)
      kubernetes.core.k8s:
        state: present
        kubeconfig: "{{ kubeconfig_path }}"
        src: "{{ sealed_secret_path }}"
        namespace: "{{ traefik_namespace }}"
      when: sealed_secret_path is defined and lookup('file', sealed_secret_path, errors='ignore') is not none

    # Esperar que el Secret sea desencriptado
    - name: â³ Esperar Secret desencriptado
      ansible.builtin.shell: >
        {{ kubectl_bin_path }} -n {{ traefik_namespace }} get secret {{ traefik_dashboard_secret_name }}
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      register: wait_for_secret
      retries: 6
      delay: 5
      until: wait_for_secret.rc == 0

    # Instalar Traefik desde el Chart de Helm
    - name: ğŸ“¦ Instalar Traefik desde Helm Chart
      ansible.builtin.shell: >
        {{ helm_bin_path }} upgrade --install {{ traefik_release_name }} traefik/traefik
        --namespace {{ traefik_namespace }}
        --create-namespace
        --version {{ traefik_chart_version }}
        --values {{ traefik_values_file }}
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
        PATH: "{{ env_path }}"

    # Esperar que el despliegue de Traefik sea exitoso
    - name: â³ Esperar despliegue Traefik
      ansible.builtin.shell: >
        {{ kubectl_bin_path }} rollout status deploy/{{ traefik_release_name }} -n {{ traefik_namespace }}
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    # Renderizar IngressRoute para el Dashboard
    - name: ğŸŒ Renderizar IngressRoute del Dashboard
      ansible.builtin.template:
        src: "{{ ingressroute_template }}"
        dest: "{{ rendered_ingressroute }}"

    # Aplicar IngressRoute del Dashboard
    - name: ğŸš€ Aplicar IngressRoute del Dashboard
      kubernetes.core.k8s:
        state: present
        namespace: "{{ traefik_namespace }}"
        src: "{{ rendered_ingressroute }}"
        kubeconfig: "{{ kubeconfig_path }}"

    # Renderizar Middleware de AutenticaciÃ³n
    - name: ğŸŒ Renderizar Middleware de AutenticaciÃ³n
      ansible.builtin.template:
        src: "{{ middleware_template }}"
        dest: "{{ rendered_middleware }}"

    # Aplicar Middleware de AutenticaciÃ³n
    - name: ğŸš€ Aplicar Middleware de AutenticaciÃ³n
      kubernetes.core.k8s:
        state: present
        namespace: "{{ traefik_namespace }}"
        src: "{{ rendered_middleware }}"
        kubeconfig: "{{ kubeconfig_path }}"