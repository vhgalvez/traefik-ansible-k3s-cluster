# playbooks\generate_internal_tls_secrets.yml
---
- name: 🔐 Crear Secret TLS autofirmado para dominios internos
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../vars/main.yml

  vars:
    certs_dir: "/etc/traefik/certs"
    cert_name: "traefik"
    rendered_secret: "{{ playbook_dir }}/files/internal-tls-secret.yaml"
    kubeconfig_path: "/home/victory/.kube/config"
    internal_tls_secret_name: "internal-tls-secret"

  tasks:
    - name: 📦 Leer certificado
      slurp:
        src: "{{ certs_dir }}/{{ cert_name }}.crt"
      register: cert_crt

    - name: 🔐 Leer clave privada
      slurp:
        src: "{{ certs_dir }}/{{ cert_name }}.key"
      register: cert_key

    - name: 📄 Renderizar plantilla de Secret TLS
      template:
        src: ../templates/secrets/tls-secret.yaml.j2
        dest: "{{ rendered_secret }}"
      vars:
        cert_base64: "{{ cert_crt.content }}"
        key_base64: "{{ cert_key.content }}"

    - name: 🚀 Aplicar Secret al clúster
      command: kubectl apply -f "{{ rendered_secret }}"
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
