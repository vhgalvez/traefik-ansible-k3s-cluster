# playbooks/4-seal-traefik-auth-secret.yml
# ===============================================================
# ğŸ” Generar y sellar el Secret de basic-auth para el dashboard
# ===============================================================

- name: ğŸ” Generar y sellar el Secret de basic-auth para el dashboard
  hosts: localhost
  gather_facts: false
  become: false # Run as current user, not root, for kubeseal

  vars_files:
    - ../vars/main.yml # Make sure traefik_auth_user, traefik_auth_pass, traefik_namespace are defined here

  vars:
    files_dir: "{{ playbook_dir }}/files"
    traefik_dashboard_secret_template: "../templates/secrets/traefik-dashboard-secret.yaml.j2"
    rendered_unsealed_secret_path: "{{ files_dir }}/traefik-dashboard-secret-unsealed.yaml"
    sealed_secret_path: "{{ files_dir }}/traefik-dashboard-sealed.yaml"
    kubeseal_path: "/usr/local/bin/kubeseal"
    kubeconfig_path: "/home/victory/.kube/config"

  tasks:
    - name: ğŸ“‹ Verificar que kubeseal estÃ© instalado
      stat:
        path: "{{ kubeseal_path }}"
      register: kubeseal_check

    - name: âŒ Abortar si kubeseal no estÃ¡ instalado
      fail:
        msg: "âŒ kubeseal no estÃ¡ instalado en {{ kubeseal_path }}. Por favor, instÃ¡lalo."
      when: not kubeseal_check.stat.exists

    - name: âš™ï¸ Asegurar que las variables de autenticaciÃ³n estÃ©n definidas
      fail:
        msg: "TRAEFIK_AUTH_USER y TRAEFIK_AUTH_PASS deben estar definidos como variables de entorno."
      when: traefik_auth_user is not defined or traefik_auth_user == "" or traefik_auth_pass is not defined or traefik_auth_pass == ""

    # Generar la cadena de basic auth para Traefik desde usuario y contraseÃ±a
    - name: ğŸ”‘ Generar la cadena de basic auth para Traefik
      shell: echo "{{ traefik_auth_pass }}" | htpasswd -i -B -n "{{ traefik_auth_user }}"
      register: basic_auth_string
      changed_when: false
      no_log: true # No mostrar la contraseÃ±a en los logs

    - name: ğŸ“ Renderizar plantilla del Secret no sellado (unsealed)
      template:
        src: "{{ traefik_dashboard_secret_template }}"
        dest: "{{ rendered_unsealed_secret_path }}"
      vars:
        traefik_basic_auth: "{{ basic_auth_string.stdout }}"
      no_log: true

    - name: ğŸ” Sellar el Secret de Traefik Dashboard con kubeseal
      ansible.builtin.command: >
        {{ kubeseal_path }}
        --controller-name sealed-secrets-controller  # <-- UPDATED LINE
        --controller-namespace kube-system
        --format yaml
        < {{ rendered_unsealed_secret_path }}
        > {{ sealed_secret_path }}
      args:
        creates: "{{ sealed_secret_path }}"
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      changed_when: true


    - name: ğŸ—‘ï¸ Limpiar el Secret no sellado (unsealed)
      file:
        path: "{{ rendered_unsealed_secret_path }}"
        state: absent
      changed_when: false