# playbooks/4-seal-traefik-auth-secret.yml
# ===============================================================
# ðŸ” Crear y cifrar Secret de autenticaciÃ³n bÃ¡sica para Traefik
# - Genera hash htpasswd (Apache)
# - Renderiza Secret plano
# - Lo cifra con kubeseal para uso en GitOps (ArgoCD)
# ===============================================================

- name: ðŸ” Generar y cifrar Secret para Traefik Dashboard
  hosts: localhost
  gather_facts: false

  vars_files:
    - ../vars/main.yml

  vars:
    kubeconfig_path: "/home/victory/.kube/config"
    kubeseal_path: "/usr/local/bin/kubeseal"
    kubectl_path: "/usr/local/bin/kubectl"
    files_dir: "{{ playbook_dir }}/files"
    rendered_secret_path: "{{ files_dir }}/traefik-dashboard-secret.yaml"
    sealed_secret_path: "{{ files_dir }}/traefik-dashboard-sealed.yaml"

  tasks:
    # âœ… Validar herramientas necesarias
    - name: ðŸ“¦ Validar si kubeseal estÃ¡ instalado
      stat:
        path: "{{ kubeseal_path }}"
      register: kubeseal_check

    - name: âŒ Abortamos si kubeseal no estÃ¡ instalado
      fail:
        msg: "âŒ kubeseal no estÃ¡ instalado en {{ kubeseal_path }}. InstÃ¡lalo antes de continuar."
      when: not kubeseal_check.stat.exists

    - name: ðŸ“¦ Validar si kubectl estÃ¡ instalado
      stat:
        path: "{{ kubectl_path }}"
      register: kubectl_check

    - name: âŒ Abortamos si kubectl no estÃ¡ instalado
      fail:
        msg: "âŒ kubectl no estÃ¡ instalado en {{ kubectl_path }}. InstÃ¡lalo antes de continuar."
      when: not kubectl_check.stat.exists

    # âœ… Validar credenciales
    - name: âŒ Abortamos si traefik_auth_user o traefik_auth_pass estÃ¡n vacÃ­os
      fail:
        msg: "âŒ Variables traefik_auth_user o traefik_auth_pass no estÃ¡n definidas. Exporta o carga .env."
      when: traefik_auth_user | length == 0 or traefik_auth_pass | length == 0

    # ðŸ“ Crear directorio si no existe
    - name: ðŸ“ Crear directorio de archivos renderizados
      file:
        path: "{{ files_dir }}"
        state: directory
        mode: "0755"

    # ðŸ” Generar hash htpasswd
    - name: ðŸ” Generar hash htpasswd
      command: htpasswd -nb {{ traefik_auth_user }} {{ traefik_auth_pass }}
      register: traefik_htpasswd_output
      no_log: true

    - name: ðŸ”§ Limpiar salto de lÃ­nea del hash generado
      set_fact:
        traefik_basic_auth: "{{ traefik_htpasswd_output.stdout | trim }}"

    # ðŸ“„ Renderizar Secret plano en YAML
    - name: ðŸ“ Renderizar Secret plano en YAML
      template:
        src: ../templates/secrets/traefik-dashboard-secret.yaml.j2
        dest: "{{ rendered_secret_path }}"
      vars:
        traefik_basic_auth: "{{ traefik_basic_auth }}"

    # ðŸ” Cifrar el Secret con kubeseal
    - name: ðŸ” Cifrar el Secret con kubeseal
      shell: >
        {{ kubeseal_path }}
        --controller-name sealed-secrets-controller
        --controller-namespace {{ traefik_namespace }}
        --format yaml
        < "{{ rendered_secret_path }}" > "{{ sealed_secret_path }}"
      args:
        executable: /bin/bash
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      changed_when: false
