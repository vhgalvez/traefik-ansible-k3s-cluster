# playbooks/install_traefik.yml
# Fase 2 - Instalar Traefik con Helm en K3s
---
- name: 🚀 Instalar Traefik con Helm dentro del clúster K3s
  hosts: localhost
  gather_facts: false
  become: false

  vars_files:
    - ../vars/main.yml

  vars:
    kubeconfig_path: "/home/victory/.kube/config"
    helm_bin_path: "/usr/local/bin/helm"
    kubectl_bin_path: "/usr/local/bin/kubectl"
    env_path: "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
    files_dir: "{{ playbook_dir }}/files"
    traefik_values_file: "{{ files_dir }}/traefik-values.yaml"
    sealed_secret_path: "{{ files_dir }}/traefik-dashboard-sealed.yaml"
    traefik_values_template: "../templates/traefik/values_nopvc.yaml.j2"
    middleware_template: "../templates/traefik/traefik-dashboard-middleware.yaml.j2"
    ingressroute_template: "../templates/traefik/traefik-dashboard-ingressroute-internal.yaml.j2"
    traefik_dashboard_middleware_name: "{{ lookup('vars', 'traefik_dashboard_middleware_name') }}"

  tasks:
    - name: ➕ Añadir repositorio Helm de Traefik
      ansible.builtin.shell: >
        {{ helm_bin_path }} repo add traefik https://traefik.github.io/charts &&
        {{ helm_bin_path }} repo update

    - name: 📁 Asegurar directorio local files/
      ansible.builtin.file:
        path: "{{ files_dir }}"
        state: directory

    - name: 📄 Renderizar values.yaml desde plantilla
      ansible.builtin.template:
        src: "{{ traefik_values_template }}"
        dest: "{{ traefik_values_file }}"

    - name: ❌ Eliminar Traefik por defecto de K3s (si existe)
      ansible.builtin.shell: |
        {{ kubectl_bin_path }} get helmcharts traefik -n kube-system &&
        {{ kubectl_bin_path }} delete helmcharts traefik -n kube-system
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
        PATH: "{{ env_path }}"
      ignore_errors: true

    - name: ➕ Añadir repositorio Helm de Traefik
      ansible.builtin.shell: >
        {{ helm_bin_path }} repo add traefik https://traefik.github.io/charts &&
        {{ helm_bin_path }} repo update
      environment:
        PATH: "{{ env_path }}"

    # 🛡️ APLICAR SEALED SECRET Y ESPERAR
    - name: 📥 Aplicar Secret sellado de Traefik (si existe)
      kubernetes.core.k8s:
        state: present
        kubeconfig: "{{ kubeconfig_path }}"
        src: "{{ sealed_secret_path }}"
        namespace: "{{ traefik_namespace }}"
      when: sealed_secret_path is defined and lookup('file', sealed_secret_path, errors='ignore') is not none

    - name: ⏳ Esperar a que el Secret desencriptado exista (SealedSecrets controller)
      ansible.builtin.shell: >
        {{ kubectl_bin_path }} -n {{ traefik_namespace }} get secret {{ traefik_dashboard_secret_name }}
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      register: wait_for_secret
      retries: 6
      delay: 5
      until: wait_for_secret.rc == 0

    - name: ✅ Confirmar que el Secret está presente
      debug:
        msg: "✔️ Secret '{{ traefik_dashboard_secret_name }}' presente en namespace '{{ traefik_namespace }}'"

    # INSTALAR TRAEFIK AHORA
    - name: 📦 Instalar Traefik desde Helm Chart
      ansible.builtin.shell: >
        {{ helm_bin_path }} upgrade --install {{ traefik_release_name }} traefik/traefik
        --namespace {{ traefik_namespace }}
        --create-namespace
        --version {{ traefik_chart_version }}
        --values {{ traefik_values_file }}
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
        PATH: "{{ env_path }}"

    - name: ⏳ Esperar a que Traefik esté listo
      ansible.builtin.shell: >
        {{ kubectl_bin_path }} rollout status deploy/{{ traefik_release_name }} -n {{ traefik_namespace }}
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    - name: 🗒️ Renderizar plantilla de Middleware traefik-auth
      ansible.builtin.template:
        src: "{{ middleware_template }}"
        dest: "{{ files_dir }}/traefik-dashboard-middleware.yaml"

    - name: 🔐 Aplicar Middleware de autenticación básica para Dashboard
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('file', files_dir + '/traefik-dashboard-middleware.yaml') | from_yaml }}"
        kubeconfig: "{{ kubeconfig_path }}"
        namespace: "{{ traefik_namespace }}"

    - name: 🧾 Renderizar plantilla de IngressRoute para Dashboard
      ansible.builtin.template:
        src: "{{ ingressroute_template }}"
        dest: "{{ files_dir }}/traefik-dashboard-ingressroute.yaml"

    - name: 🚪 Desplegar IngressRoute para Dashboard
      kubernetes.core.k8s:
        state: present
        namespace: "{{ traefik_namespace }}"
        src: "{{ files_dir }}/traefik-dashboard-ingressroute.yaml"
        kubeconfig: "{{ kubeconfig_path }}"

    - name: 📁 Crear directorio /opt/traefik/acme en master1
      ansible.builtin.file:
        path: /opt/traefik/acme
        state: directory
        mode: '0755'
      delegate_to: master1
      become: true
    
    - name: 📁 Verificar existencia de /opt/traefik/acme en master1
      ansible.builtin.stat:
        path: /opt/traefik/acme
      delegate_to: master1
      register: traefik_acme_dir

    - name: 📋 Mostrar estado del directorio en master1
      debug:
        var: traefik_acme_dir.stat