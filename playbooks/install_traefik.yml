# playbooks/deploy_traefik.yml
---
- name: 🚀 Instalar Traefik con Helm dentro del clúster K3s
  hosts: localhost
  become: false
  vars:
    kubeconfig_path: /home/victory/.kube/config
    helm_bin_path: /usr/local/bin/helm
    kubectl_path: /usr/local/bin/kubectl
    traefik_namespace: kube-system
    traefik_release_name: traefik
    traefik_chart_version: "26.1.0"
    traefik_values_file: "/tmp/traefik-values.yaml"
  tasks:

    - name: 📁 Asegurar directorio local files/
      file:
        path: ./files/
        state: directory

    - name: 📄 Renderizar values.yaml desde plantilla
      template:
        src: templates/traefik/values.yaml.j2
        dest: "{{ traefik_values_file }}"

    - name: ❌ Desinstalar Traefik por defecto de K3s (si existe)
      command: >
        {{ kubectl_path }} delete helmcharts traefik -n kube-system
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      ignore_errors: true

    - name: ➕ Añadir repositorio Helm de Traefik
      shell: |
        export PATH=$PATH:/usr/local/bin
        helm repo add traefik https://traefik.github.io/charts
        helm repo update
      args:
        executable: /bin/bash

    - name: 🚀 Instalar Traefik con Helm
      shell: |
        export PATH=$PATH:/usr/local/bin
        helm upgrade --install {{ traefik_release_name }} traefik/traefik \
          --namespace {{ traefik_namespace }} \
          --create-namespace \
          --version {{ traefik_chart_version }} \
          --values {{ traefik_values_file }}
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      args:
        executable: /bin/bash

    - name: 🧪 Verificar conexión con el clúster Kubernetes
      command: "{{ kubectl_path }} get nodes"
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      register: kubectl_result
      failed_when: kubectl_result.rc != 0
      changed_when: false

    - name: 📊 Mostrar resultado de kubectl
      debug:
        msg: "{{ kubectl_result.stdout }}"