# playbooks/install_traefik.yml
# ğŸ“„ Paso 1: Renderizar values.yaml en localhost
- name: ğŸ“„ Renderizar plantilla values.yaml
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../vars/main.yml
  vars:
    rendered_values_file: "{{ playbook_dir }}/files/traefik-values.yaml"
  tasks:
    - name: ğŸ“ Crear directorio de salida si no existe
      file:
        path: "{{ playbook_dir }}/files"
        state: directory
        mode: "0755"

    - name: ğŸ“„ Renderizar values.yaml desde plantilla
      template:
        src: ../templates/traefik/values.yaml.j2
        dest: "{{ rendered_values_file }}"

# âŒ Paso 2: Eliminar Traefik por defecto de K3s (desde master1)
- name: âŒ Desinstalar Traefik de K3s si existe
  hosts: master1
  gather_facts: false
  vars_files:
    - ../vars/main.yml
  tasks:
    - name: ğŸ§¼ Eliminar helmchart traefik (K3s)
      raw: |
        KUBECONFIG={{ kubeconfig_path }} kubectl delete helmcharts traefik -n kube-system || true

    - name: ğŸ§¼ Eliminar deployment traefik (por si queda activo)
      raw: |
        KUBECONFIG={{ kubeconfig_path }} kubectl delete deployment traefik -n kube-system || true

# ğŸš€ Paso 3: Instalar Traefik con Helm (en master1)
- name: ğŸš€ Instalar Traefik con Helm
  hosts: master1
  gather_facts: false
  vars_files:
    - ../vars/main.yml
  vars:
    rendered_values_file: "{{ playbook_dir }}/files/traefik-values.yaml"
  tasks:
    - name: â• AÃ±adir repositorio de Traefik
      raw: |
        helm repo add traefik https://traefik.github.io/charts || true
        helm repo update

    - name: ğŸ“ Crear directorio de certificados ACME (si aplica)
      raw: |
        mkdir -p /data/traefik
        touch /data/traefik/acme.json
        chmod 600 /data/traefik/acme.json

    - name: ğŸš€ Instalar Traefik con Helm
      raw: |
        helm upgrade --install {{ traefik_release_name }} traefik/traefik \
          --namespace {{ traefik_namespace }} \
          --create-namespace=true \
          --version {{ traefik_chart_version }} \
          --values {{ rendered_values_file }} \
          --kubeconfig {{ kubeconfig_path }}