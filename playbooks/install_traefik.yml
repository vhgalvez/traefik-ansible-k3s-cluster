---
- name: 🚀 Instalar Traefik con Helm dentro del clúster K3s
  hosts: localhost
  gather_facts: false
  become: false

  vars_files:
    - ../vars/main.yml

  vars:
    kubeconfig_path: "/home/victory/.kube/config"
    helm_bin_path: "/usr/local/bin/helm"
    kubectl_bin_path: "/usr/local/bin/kubectl"
    traefik_values_file: "{{ playbook_dir }}/files/traefik-values.yaml"

  tasks:
    - name: 📁 Asegurar directorio local files/
      file:
        path: "{{ playbook_dir }}/files"
        state: directory

    - name: 📄 Renderizar values.yaml desde plantilla
      template:
        src: "../templates/traefik/values.yaml.j2"
        dest: "{{ traefik_values_file }}"

    - name: ❌ Desinstalar Traefik por defecto de K3s (si existe)
      shell: >
        {{ kubectl_bin_path }} delete helmcharts traefik -n kube-system
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      ignore_errors: true

    - name: ➕ Añadir repositorio Helm de Traefik
      shell: >
        {{ helm_bin_path }} repo add traefik https://traefik.github.io/charts &&
        {{ helm_bin_path }} repo update

    - name: 📦 Instalar Traefik desde Helm Chart
      shell: >
        {{ helm_bin_path }} upgrade --install {{ traefik_release_name }} traefik/traefik
        --namespace {{ traefik_namespace }}
        --create-namespace
        --version {{ traefik_chart_version }}
        --values {{ traefik_values_file }}
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"