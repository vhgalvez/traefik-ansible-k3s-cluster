# playbooks\install_traefik.yml
---
- name: Preparar entorno remoto para Traefik en K3s
  hosts: controller
  gather_facts: false
  vars:
    traefik_values_file: "/tmp/traefik-values.yaml"
  tasks:
    - name: Desinstalar Traefik instalado por defecto en K3s (si existe)
      ansible.builtin.raw: |
        kubectl delete helmchart traefik -n kube-system || true
        kubectl delete deployment traefik -n kube-system || true

    - name: Copiar values.yaml al nodo remoto
      copy:
        src: "{{ playbook_dir }}/files/traefik-values.yaml"
        dest: "{{ traefik_values_file }}"
        force: yes

- name: Instalar Traefik desde localhost con Helm apuntando al clúster
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    traefik_namespace: kube-system
    traefik_release_name: traefik
    traefik_chart_version: "23.1.0"
    traefik_values_file: "{{ playbook_dir }}/files/traefik-values.yaml"
    traefik_dashboard_user: admin
    traefik_dashboard_pass: MiPasswordSegura
  tasks:
    - name: Asegurarse de que el directorio files/ exista localmente
      file:
        path: "{{ playbook_dir }}/files"
        state: directory
        mode: "0755"

    - name: Generar hash htpasswd localmente con Python
      command: >
        python3 -c "import crypt; print('{{ traefik_dashboard_user }}:' + crypt.crypt('{{ traefik_dashboard_pass }}', crypt.mksalt(crypt.METHOD_MD5)))"
      register: htpasswd_output

    - name: Guardar hash htpasswd en archivo local
      copy:
        dest: "{{ playbook_dir }}/files/htpasswd.txt"
        content: "{{ htpasswd_output.stdout }}"

    - name: Renderizar values.yaml localmente con Jinja2
      template:
        src: ../templates/traefik/values.yaml.j2
        dest: "{{ traefik_values_file }}"

    - name: Asegurarse de que el repo de Traefik esté añadido
      shell: |
        helm repo add traefik https://traefik.github.io/charts || true
        helm repo update
      args:
        executable: /bin/bash

    - name: Crear secret de autenticación básica para dashboard de Traefik
      shell: >
        kubectl -n {{ traefik_namespace }} create secret generic traefik-dashboard-auth
        --from-literal=users="{{ htpasswd_output.stdout }}"
        --dry-run=client -o yaml | kubectl apply -f -
      args:
        executable: /bin/bash

    - name: Instalar Traefik con Helm en el clúster
      shell: |
        helm upgrade --install {{ traefik_release_name }} traefik/traefik \
          --namespace {{ traefik_namespace }} \
          --create-namespace=false \
          --version {{ traefik_chart_version }} \
          --values {{ traefik_values_file }}
      args:
        executable: /bin/bash

    - name: Crear Middleware de autenticación básica para dashboard
      shell: |
        cat <<EOF | kubectl apply -f -
        apiVersion: traefik.containo.us/v1alpha1
        kind: Middleware
        metadata:
          name: dashboard-auth
          namespace: {{ traefik_namespace }}
        spec:
          basicAuth:
            secret: traefik-dashboard-auth
        EOF
      args:
        executable: /bin/bash

    - name: Crear IngressRoute para acceder al dashboard protegido
      shell: |
        cat <<EOF | kubectl apply -f -
        apiVersion: traefik.containo.us/v1alpha1
        kind: IngressRoute
        metadata:
          name: traefik-dashboard
          namespace: {{ traefik_namespace }}
        spec:
          entryPoints:
            - websecure
          routes:
            - match: PathPrefix(\`/dashboard\`) || PathPrefix(\`/api\`)
              kind: Rule
              services:
                - name: api@internal
                  kind: TraefikService
              middlewares:
                - name: dashboard-auth
          tls:
            certResolver: selfsigned
        EOF
      args:
        executable: /bin/bash